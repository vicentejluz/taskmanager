<?xml version="1.0" encoding="UTF-8"?>
<configuration>

    <!-- ===================== -->
    <!-- PROPRIEDADES GERAIS -->
    <!-- ===================== -->
    <property name="LOG_FILENAME" value="taskmanager"/>
    <property name="LOG_PATH" value="logs"/>
    <property name ="LOGSTASH_HOST" value="localhost"/>

    <!-- ===================== -->
    <!-- DEV PROFILE -->
    <!-- ===================== -->
    <springProfile name="dev">

        <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
            <encoder>
                <pattern>
                    %cyan(%d{ISO8601}) %yellow([%thread]) %highlight(%-5level) %green(%logger{36}) - %msg%n
                </pattern>
            </encoder>
        </appender>

        <!-- Arquivo -->
        <appender name="FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
            <file>${LOG_PATH}/${LOG_FILENAME}.log</file>

            <rollingPolicy class="ch.qos.logback.core.rolling.FixedWindowRollingPolicy">
                <fileNamePattern>${LOG_PATH}/${LOG_FILENAME}-%i.log</fileNamePattern>
                <minIndex>1</minIndex>
                <maxIndex>8</maxIndex>
            </rollingPolicy>

            <triggeringPolicy class="ch.qos.logback.core.rolling.SizeBasedTriggeringPolicy">
                <maxFileSize>10MB</maxFileSize>
            </triggeringPolicy>

            <encoder>
                <pattern>%d{ISO8601} [%thread] %-5level %logger{36} - %msg%n</pattern>
            </encoder>
        </appender>

        <appender name="LOGSTASH"
                  class="net.logstash.logback.appender.LogstashTcpSocketAppender">
            <destination>${LOGSTASH_HOST}:5044</destination>
            <encoder class="net.logstash.logback.encoder.LogstashEncoder"/>
        </appender>

        <!-- Logs da aplicação -->
        <root level="INFO">
            <appender-ref ref="CONSOLE"/>
        </root>

        <!-- Reduz barulho do Spring -->
        <logger name="org.springframework" level="INFO"/>
        <logger name="org.hibernate" level="WARN"/>
        <logger name="com.vicente.taskmanager" level="DEBUG">
            <appender-ref ref="FILE"/>
            <appender-ref ref="LOGSTASH"/>
        </logger>

        <!-- Graceful shutdown do Tomcat -->
        <logger name="org.springframework.boot.tomcat.GracefulShutdown"
                level="INFO">
            <appender-ref ref="FILE"/>
            <appender-ref ref="LOGSTASH"/>
        </logger>
        <!-- Graceful shutdown do Tomcat -->
        <logger name="org.springframework.boot.tomcat.TomcatWebServer"
                level="INFO">
            <appender-ref ref="FILE"/>
            <appender-ref ref="LOGSTASH"/>
        </logger>

        <!-- Fechamento do EntityManager -->
        <logger name="org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean"
                level="INFO">
            <appender-ref ref="FILE"/>
            <appender-ref ref="LOGSTASH"/>
        </logger>

        <!-- Shutdown do HikariCP -->
        <logger name="com.zaxxer.hikari.HikariDataSource"
                level="INFO">
            <appender-ref ref="FILE"/>
            <appender-ref ref="LOGSTASH"/>
        </logger>

    </springProfile>

    <!-- ===================== -->
    <!-- PROD PROFILE -->
    <!-- ===================== -->
    <springProfile name="prod">

        <!-- Console (ex: Docker, Kubernetes) -->
        <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
            <encoder>
                <pattern>
                    %cyan(%d{ISO8601}) %yellow([%thread]) %highlight(%-5level) %green(%logger{36}) - %msg%n
                </pattern>
            </encoder>
        </appender>

        <!-- Arquivo -->
        <appender name="FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
            <file>${LOG_PATH}/${LOG_FILENAME}.log</file>

            <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
                <fileNamePattern>
                    ${LOG_PATH}/${LOG_FILENAME}-%d{yyyy-MM-dd}-%i.log
                </fileNamePattern>
                <maxFileSize>100MB</maxFileSize>
                <maxHistory>90</maxHistory>
                <totalSizeCap>1GB</totalSizeCap>
            </rollingPolicy>

            <encoder>
                <pattern>
                    %d{ISO8601} [%thread] %-5level %logger{36} - %msg%n
                </pattern>
            </encoder>
        </appender>
        <appender name="LOGSTASH"
                  class="net.logstash.logback.appender.LogstashTcpSocketAppender">
            <destination>${LOGSTASH_HOST:localhost}:5044</destination>

            <encoder class="net.logstash.logback.encoder.LogstashEncoder"/>
        </appender>

        <root level="INFO">
            <appender-ref ref="CONSOLE"/>
            <appender-ref ref="FILE"/>
            <appender-ref ref="LOGSTASH"/>
        </root>

        <!-- Frameworks mais silenciosos -->
        <logger name="org.springframework" level="WARN"/>
        <logger name="org.hibernate" level="WARN"/>

    </springProfile>

</configuration>

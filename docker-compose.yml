services:
  db:
    image: postgres:18.1-alpine3.23
    container_name: postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${PG_DB}
      POSTGRES_USER: ${PG_USER}
      POSTGRES_PASSWORD: ${PG_PASSWORD}
    ports:
      - "5432:5432"
    volumes:
      - pg-data:/var/lib/postgresql/data

  elasticsearch:
      image: elasticsearch:9.3.0
      container_name: elasticsearch
      restart: on-failure
      environment:
        discovery.type: single-node
        xpack.security.enabled: false # Disable security for local development
        ES_JAVA_OPTS: -Xms512m -Xmx512m
      ports:
        - "9200:9200"
      volumes:
        - es_data:/usr/share/elasticsearch/data
      networks:
        - elk-network


  logstash:
      image: logstash:9.3.0
      container_name: logstash
      restart: on-failure
      platform: linux/amd64
      depends_on:
        - elasticsearch
      environment:
        LS_JAVA_OPTS: -Xms256m -Xmx256m
      ports:
        - "5044:5044"
      volumes:
        - ./logstash/pipeline:/usr/share/logstash/pipeline
      networks:
        - elk-network

  kibana:
    image: kibana:9.3.0
    container_name: kibana
    restart: on-failure
    depends_on:
      - elasticsearch
    environment:
      ELASTICSEARCH_HOSTS: http://elasticsearch:9200
    ports:
      - "5601:5601"
    networks:
      - elk-network

  mailpit:
    image: axllent/mailpit:latest
    container_name: mailpit
    restart: always
    ports:
      - "8025:8025" # üåê Web GUI
      - "1025:1025" # üìÆ SMTP
    volumes:
      - mailpit-data:/data  # üíæ Persistent storage for messages
      - ./mailpit/certs:/certs
    environment:
      MP_SMTP_AUTH: ${MAILPIT_USER}:${MAILPIT_PASSWORD}        # üë§ SMTP login credentials
      MP_UI_AUTH: ${MAILPIT_USER}:${MAILPIT_PASSWORD}          # üîë Web UI login credentials
#      MAIL_FROM_ADDRESS: taskmanager@mailpit.com
      MP_SMTP_TLS_CERT: /certs/cert.pem
      MP_SMTP_TLS_KEY: /certs/key.pem
      MP_DATABASE: /data
      MP_MAX_MESSAGES: 3000                # üíå Max number of stored messages
      MP_VERBOSE: true                      # ü™µ Enable verbose logging
    healthcheck:
      test: [ "CMD", "/mailpit", "readyz" ]
      interval: 15s
      start_period: 10s
      timeout: 30s
      retries: 3

volumes:
  pg-data:
  es_data:
  mailpit-data:

networks:
  elk-network:


